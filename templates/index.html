<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 文案生成工具 - 四階段流程</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>🤖 AI 文案生成工具</h1>
            <p class="subtitle">四階段智能文案生成流程</p>
        </header>

        <!-- Step 1: 輸入原始文字 -->
        <section class="step-section" id="step1">
            <div class="step-header">
                <span class="step-number">1</span>
                <h2>輸入原始文字</h2>
            </div>
            
            <div class="input-group">
                <label for="language">選擇語言：</label>
                <select id="language">
                    <option value="中文">中文</option>
                    <option value="英文">英文</option>
                    <option value="自動檢測">自動檢測</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="inputText">貼上您的原始文字：</label>
                <textarea id="inputText" placeholder="請貼上文章、廣告文案、新聞稿等內容..."></textarea>
            </div>
            
            <button class="btn btn-primary" onclick="decomposeText()">開始解析</button>
        </section>

        <!-- Step 2: 拆解內容確認 -->
        <section class="step-section" id="step2" style="display: none;">
            <div class="step-header">
                <span class="step-number">2</span>
                <h2>確認拆解內容</h2>
            </div>
            
            <div class="decomposition-container">
                <div class="decomposition-card">
                    <h3>標題建議</h3>
                    <input type="text" id="title" class="decomposition-input">
                </div>
                
                <div class="decomposition-card">
                    <h3>目標受眾</h3>
                    <input type="text" id="audience" class="decomposition-input">
                </div>
                
                <div class="decomposition-card">
                    <h3>文案目的</h3>
                    <input type="text" id="purpose" class="decomposition-input">
                </div>
                
                <div class="decomposition-card">
                    <h3>語調風格</h3>
                    <input type="text" id="tone" class="decomposition-input">
                </div>
                
                <div class="decomposition-card">
                    <h3>建議長度</h3>
                    <input type="text" id="length" class="decomposition-input">
                </div>
                
                <div class="decomposition-card full-width">
                    <h3>關鍵要點</h3>
                    <div id="keyPointsContainer" class="key-points-container">
                        <!-- 動態生成要點輸入框 -->
                    </div>
                    <button class="btn btn-secondary" onclick="addKeyPoint()">新增要點</button>
                </div>
                
                <div class="decomposition-card">
                    <h3>事實或限制</h3>
                    <input type="text" id="facts" class="decomposition-input">
                </div>
                
                <div class="decomposition-card">
                    <h3>行動呼籲</h3>
                    <input type="text" id="callToAction" class="decomposition-input">
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="confirmDecomposition()">確認拆解內容</button>
        </section>

        <!-- Step 3: 生成新文案 -->
        <section class="step-section" id="step3" style="display: none;">
            <div class="step-header">
                <span class="step-number">3</span>
                <h2>生成新文案</h2>
            </div>
            
            <div class="generation-options">
                <div class="option-group">
                    <label>文案風格：</label>
                    <div class="radio-group">
                        <label><input type="radio" name="style" value="活潑" checked> 活潑</label>
                        <label><input type="radio" name="style" value="專業"> 專業</label>
                        <label><input type="radio" name="style" value="學術"> 學術</label>
                        <label><input type="radio" name="style" value="幽默"> 幽默</label>
                    </div>
                </div>
                
                <div class="option-group">
                    <label>文案形式：</label>
                    <div class="radio-group">
                        <label><input type="radio" name="form" value="社群貼文" checked> 社群貼文</label>
                        <label><input type="radio" name="form" value="Email標題"> Email標題</label>
                        <label><input type="radio" name="form" value="完整文章"> 完整文章</label>
                    </div>
                </div>
                
                <div class="option-group">
                    <label>字數長度：</label>
                    <div class="radio-group">
                        <label><input type="radio" name="length" value="短"> 短</label>
                        <label><input type="radio" name="length" value="中" checked> 中</label>
                        <label><input type="radio" name="length" value="長"> 長</label>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="generateContent()">生成文案</button>
        </section>

        <!-- Step 4: 顯示與迭代 -->
        <section class="step-section" id="step4" style="display: none;">
            <div class="step-header">
                <span class="step-number">4</span>
                <h2>生成結果與迭代</h2>
            </div>
            
            <div class="result-container">
                <div class="result-header">
                    <h3>生成的文案</h3>
                    <div class="result-meta" id="resultMeta"></div>
                </div>
                
                <div class="generated-text" id="generatedText"></div>
                
                <div class="result-actions">
                    <button class="btn btn-success" onclick="downloadContent()">下載文案</button>
                    <button class="btn btn-secondary" onclick="regenerateContent()">重新生成</button>
                    <button class="btn btn-outline" onclick="modifyDecomposition()">修改拆解內容</button>
                </div>
            </div>
            
            <div class="versions-container" id="versionsContainer" style="display: none;">
                <h3>版本紀錄</h3>
                <div id="versionsList"></div>
            </div>
        </section>

        <!-- 進度指示器 -->
        <div class="progress-bar">
            <div class="progress-step active" data-step="1">輸入</div>
            <div class="progress-step" data-step="2">拆解</div>
            <div class="progress-step" data-step="3">生成</div>
            <div class="progress-step" data-step="4">完成</div>
        </div>
    </div>

    <script>
        let currentConfirmedId = null;
        let currentVersionId = null;

        // Step 1: 拆解文字
        async function decomposeText() {
            const text = document.getElementById('inputText').value.trim();
            const language = document.getElementById('language').value;
            
            if (!text) {
                alert('請輸入文字內容');
                return;
            }
            
            try {
                const response = await fetch('/decompose', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({ text, language })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // 填充拆解內容
                fillDecomposition(data.decomposition);
                
                // 顯示Step 2
                showStep(2);
                updateProgress(2);
                
            } catch (error) {
                console.error('拆解失敗:', error);
                alert('拆解失敗，請重試');
            }
        }

        function fillDecomposition(decomposition) {
            document.getElementById('title').value = decomposition.title_suggestion || '';
            document.getElementById('audience').value = decomposition.audience || '';
            document.getElementById('purpose').value = decomposition.purpose || '';
            document.getElementById('tone').value = decomposition.tone || '';
            document.getElementById('length').value = decomposition.length || '';
            document.getElementById('facts').value = decomposition.facts_or_constraints?.join(', ') || '';
            document.getElementById('callToAction').value = decomposition.call_to_action || '';
            
            // 填充關鍵要點
            const container = document.getElementById('keyPointsContainer');
            container.innerHTML = '';
            
            if (decomposition.key_points && decomposition.key_points.length > 0) {
                decomposition.key_points.forEach(point => {
                    addKeyPointInput(point);
                });
            } else {
                addKeyPointInput();
            }
        }

        function addKeyPoint() {
            addKeyPointInput();
        }

        function addKeyPointInput(value = '') {
            const container = document.getElementById('keyPointsContainer');
            const div = document.createElement('div');
            div.className = 'key-point-item';
            div.innerHTML = `
                <input type="text" class="key-point-input" value="${value}" placeholder="輸入關鍵要點">
                <button type="button" class="btn-remove" onclick="removeKeyPoint(this)">×</button>
            `;
            container.appendChild(div);
        }

        function removeKeyPoint(button) {
            button.parentElement.remove();
        }

        // Step 2: 確認拆解內容
        async function confirmDecomposition() {
            const decomposition = {
                title_suggestion: document.getElementById('title').value,
                audience: document.getElementById('audience').value,
                purpose: document.getElementById('purpose').value,
                tone: document.getElementById('tone').value,
                length: document.getElementById('length').value,
                key_points: Array.from(document.querySelectorAll('.key-point-input')).map(input => input.value).filter(v => v.trim()),
                facts_or_constraints: document.getElementById('facts').value.split(',').map(s => s.trim()).filter(s => s),
                call_to_action: document.getElementById('callToAction').value
            };
            
            try {
                const response = await fetch('/confirm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ decomposition })
                });
                
                const data = await response.json();
                currentConfirmedId = data.confirmed_id;
                
                // 顯示Step 3
                showStep(3);
                updateProgress(3);
                
            } catch (error) {
                console.error('確認失敗:', error);
                alert('確認失敗，請重試');
            }
        }

        // Step 3: 生成文案
        async function generateContent() {
            const style = document.querySelector('input[name="style"]:checked').value;
            const form = document.querySelector('input[name="form"]:checked').value;
            const length = document.querySelector('input[name="length"]:checked').value;
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        confirmed_id: currentConfirmedId,
                        style,
                        form,
                        length
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                currentVersionId = data.version_id;
                
                // 顯示生成結果
                document.getElementById('generatedText').textContent = data.generated_text;
                document.getElementById('resultMeta').innerHTML = `
                    <span>風格：${data.metadata.style}</span>
                    <span>形式：${data.metadata.form}</span>
                    <span>長度：${data.metadata.length}</span>
                    <span>時間：${new Date(data.metadata.timestamp).toLocaleString()}</span>
                `;
                
                // 顯示Step 4
                showStep(4);
                updateProgress(4);
                
                // 載入版本紀錄
                loadVersions();
                
            } catch (error) {
                console.error('生成失敗:', error);
                alert('生成失敗，請重試');
            }
        }

        // Step 4: 下載文案
        async function downloadContent() {
            if (!currentVersionId) {
                alert('沒有可下載的文案');
                return;
            }
            
            window.open(`/download/${currentVersionId}`, '_blank');
        }

        // 重新生成文案
        async function regenerateContent() {
            const style = document.querySelector('input[name="style"]:checked').value;
            const form = document.querySelector('input[name="form"]:checked').value;
            const length = document.querySelector('input[name="length"]:checked').value;
            
            try {
                const response = await fetch('/regenerate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        confirmed_id: currentConfirmedId,
                        style,
                        form,
                        length
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                currentVersionId = data.version_id;
                
                // 更新顯示結果
                document.getElementById('generatedText').textContent = data.generated_text;
                document.getElementById('resultMeta').innerHTML = `
                    <span>風格：${data.metadata.style}</span>
                    <span>形式：${data.metadata.form}</span>
                    <span>長度：${data.metadata.length}</span>
                    <span>時間：${new Date(data.metadata.timestamp).toLocaleString()}</span>
                `;
                
                // 重新載入版本紀錄
                loadVersions();
                
            } catch (error) {
                console.error('重新生成失敗:', error);
                alert('重新生成失敗，請重試');
            }
        }

        // 修改拆解內容
        function modifyDecomposition() {
            showStep(2);
            updateProgress(2);
        }

        // 載入版本紀錄
        async function loadVersions() {
            if (!currentConfirmedId) return;
            
            try {
                const response = await fetch(`/versions/${currentConfirmedId}`);
                const versions = await response.json();
                
                if (versions.length > 0) {
                    const container = document.getElementById('versionsContainer');
                    const list = document.getElementById('versionsList');
                    
                    list.innerHTML = versions.map(version => `
                        <div class="version-item">
                            <div class="version-info">
                                <span class="version-style">${version.style}</span>
                                <span class="version-form">${version.form}</span>
                                <span class="version-length">${version.length}</span>
                                <span class="version-time">${new Date(version.timestamp).toLocaleString()}</span>
                            </div>
                            <div class="version-actions">
                                <button class="btn btn-small" onclick="downloadVersion('${version.id}')">下載</button>
                            </div>
                        </div>
                    `).join('');
                    
                    container.style.display = 'block';
                }
            } catch (error) {
                console.error('載入版本紀錄失敗:', error);
            }
        }

        // 下載特定版本
        async function downloadVersion(versionId) {
            window.open(`/download/${versionId}`, '_blank');
        }

        // 顯示指定步驟
        function showStep(stepNumber) {
            // 隱藏所有步驟
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).style.display = 'none';
            }
            
            // 顯示指定步驟
            document.getElementById(`step${stepNumber}`).style.display = 'block';
        }

        // 更新進度條
        function updateProgress(activeStep) {
            const steps = document.querySelectorAll('.progress-step');
            steps.forEach((step, index) => {
                if (index + 1 <= activeStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateProgress(1);
        });
    </script>
</body>
</html>
