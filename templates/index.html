<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ–‡æ¡ˆç”Ÿæˆå·¥å…· - å››éšæ®µæµç¨‹</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¤– AI æ–‡æ¡ˆç”Ÿæˆå·¥å…·</h1>
            <p class="subtitle">å››éšæ®µæ™ºèƒ½æ–‡æ¡ˆç”Ÿæˆæµç¨‹</p>
        </header>

        <!-- Step 1: è¼¸å…¥åŸå§‹æ–‡å­— -->
        <section class="step-section" id="step1">
            <div class="step-header">
                <span class="step-number">1</span>
                <h2>è¼¸å…¥åŸå§‹æ–‡å­—</h2>
            </div>
            
            <div class="input-group">
                <label for="language">é¸æ“‡èªè¨€ï¼š</label>
                <select id="language">
                    <option value="ä¸­æ–‡">ä¸­æ–‡</option>
                    <option value="è‹±æ–‡">è‹±æ–‡</option>
                    <option value="è‡ªå‹•æª¢æ¸¬">è‡ªå‹•æª¢æ¸¬</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="inputText">è²¼ä¸Šæ‚¨çš„åŸå§‹æ–‡å­—ï¼š</label>
                <textarea id="inputText" placeholder="è«‹è²¼ä¸Šæ–‡ç« ã€å»£å‘Šæ–‡æ¡ˆã€æ–°èç¨¿ç­‰å…§å®¹..."></textarea>
            </div>
            
            <button class="btn btn-primary" onclick="decomposeText()">é–‹å§‹è§£æ</button>
        </section>

        <!-- Step 2: æ‹†è§£å…§å®¹ç¢ºèª -->
        <section class="step-section" id="step2" style="display: none;">
            <div class="step-header">
                <span class="step-number">2</span>
                <h2>ç¢ºèªæ‹†è§£å…§å®¹</h2>
            </div>
            
            <div class="decomposition-container">
                <div class="decomposition-card">
                    <h3>æ¨™é¡Œå»ºè­°</h3>
                    <input type="text" id="title" class="decomposition-input">
                </div>
                
                <div class="decomposition-card">
                    <h3>ç›®æ¨™å—çœ¾</h3>
                    <input type="text" id="audience" class="decomposition-input">
                </div>
                
                <div class="decomposition-card">
                    <h3>æ–‡æ¡ˆç›®çš„</h3>
                    <input type="text" id="purpose" class="decomposition-input">
                </div>
                
                <div class="decomposition-card">
                    <h3>èªèª¿é¢¨æ ¼</h3>
                    <input type="text" id="tone" class="decomposition-input">
                </div>
                
                <div class="decomposition-card">
                    <h3>å»ºè­°é•·åº¦</h3>
                    <input type="text" id="length" class="decomposition-input">
                </div>
                
                <div class="decomposition-card full-width">
                    <h3>é—œéµè¦é»</h3>
                    <div id="keyPointsContainer" class="key-points-container">
                        <!-- å‹•æ…‹ç”Ÿæˆè¦é»è¼¸å…¥æ¡† -->
                    </div>
                    <button class="btn btn-secondary" onclick="addKeyPoint()">æ–°å¢è¦é»</button>
                </div>
                
                <div class="decomposition-card">
                    <h3>äº‹å¯¦æˆ–é™åˆ¶</h3>
                    <input type="text" id="facts" class="decomposition-input">
                </div>
                
                <div class="decomposition-card">
                    <h3>è¡Œå‹•å‘¼ç±²</h3>
                    <input type="text" id="callToAction" class="decomposition-input">
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="confirmDecomposition()">ç¢ºèªæ‹†è§£å…§å®¹</button>
        </section>

        <!-- Step 3: ç”Ÿæˆæ–°æ–‡æ¡ˆ -->
        <section class="step-section" id="step3" style="display: none;">
            <div class="step-header">
                <span class="step-number">3</span>
                <h2>ç”Ÿæˆæ–°æ–‡æ¡ˆ</h2>
            </div>
            
            <div class="generation-options">
                <div class="option-group">
                    <label>æ–‡æ¡ˆé¢¨æ ¼ï¼š</label>
                    <div class="radio-group">
                        <label><input type="radio" name="style" value="æ´»æ½‘" checked> æ´»æ½‘</label>
                        <label><input type="radio" name="style" value="å°ˆæ¥­"> å°ˆæ¥­</label>
                        <label><input type="radio" name="style" value="å­¸è¡“"> å­¸è¡“</label>
                        <label><input type="radio" name="style" value="å¹½é»˜"> å¹½é»˜</label>
                    </div>
                </div>
                
                <div class="option-group">
                    <label>æ–‡æ¡ˆå½¢å¼ï¼š</label>
                    <div class="radio-group">
                        <label><input type="radio" name="form" value="ç¤¾ç¾¤è²¼æ–‡" checked> ç¤¾ç¾¤è²¼æ–‡</label>
                        <label><input type="radio" name="form" value="Emailæ¨™é¡Œ"> Emailæ¨™é¡Œ</label>
                        <label><input type="radio" name="form" value="å®Œæ•´æ–‡ç« "> å®Œæ•´æ–‡ç« </label>
                    </div>
                </div>
                
                <div class="option-group">
                    <label>å­—æ•¸é•·åº¦ï¼š</label>
                    <div class="radio-group">
                        <label><input type="radio" name="length" value="çŸ­"> çŸ­</label>
                        <label><input type="radio" name="length" value="ä¸­" checked> ä¸­</label>
                        <label><input type="radio" name="length" value="é•·"> é•·</label>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="generateContent()">ç”Ÿæˆæ–‡æ¡ˆ</button>
        </section>

        <!-- Step 4: é¡¯ç¤ºèˆ‡è¿­ä»£ -->
        <section class="step-section" id="step4" style="display: none;">
            <div class="step-header">
                <span class="step-number">4</span>
                <h2>ç”Ÿæˆçµæœèˆ‡è¿­ä»£</h2>
            </div>
            
            <div class="result-container">
                <div class="result-header">
                    <h3>ç”Ÿæˆçš„æ–‡æ¡ˆ</h3>
                    <div class="result-meta" id="resultMeta"></div>
                </div>
                
                <div class="generated-text" id="generatedText"></div>
                
                <div class="result-actions">
                    <button class="btn btn-success" onclick="downloadContent()">ä¸‹è¼‰æ–‡æ¡ˆ</button>
                    <button class="btn btn-secondary" onclick="regenerateContent()">é‡æ–°ç”Ÿæˆ</button>
                    <button class="btn btn-outline" onclick="modifyDecomposition()">ä¿®æ”¹æ‹†è§£å…§å®¹</button>
                </div>
            </div>
            
            <div class="versions-container" id="versionsContainer" style="display: none;">
                <h3>ç‰ˆæœ¬ç´€éŒ„</h3>
                <div id="versionsList"></div>
            </div>
        </section>

        <!-- é€²åº¦æŒ‡ç¤ºå™¨ -->
        <div class="progress-bar">
            <div class="progress-step active" data-step="1">è¼¸å…¥</div>
            <div class="progress-step" data-step="2">æ‹†è§£</div>
            <div class="progress-step" data-step="3">ç”Ÿæˆ</div>
            <div class="progress-step" data-step="4">å®Œæˆ</div>
        </div>
    </div>

    <script>
        let currentConfirmedId = null;
        let currentVersionId = null;

        // Step 1: æ‹†è§£æ–‡å­—
        async function decomposeText() {
            const text = document.getElementById('inputText').value.trim();
            const language = document.getElementById('language').value;
            
            if (!text) {
                alert('è«‹è¼¸å…¥æ–‡å­—å…§å®¹');
                return;
            }
            
            try {
                const response = await fetch('/decompose', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({ text, language })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // å¡«å……æ‹†è§£å…§å®¹
                fillDecomposition(data.decomposition);
                
                // é¡¯ç¤ºStep 2
                showStep(2);
                updateProgress(2);
                
            } catch (error) {
                console.error('æ‹†è§£å¤±æ•—:', error);
                alert('æ‹†è§£å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        function fillDecomposition(decomposition) {
            document.getElementById('title').value = decomposition.title_suggestion || '';
            document.getElementById('audience').value = decomposition.audience || '';
            document.getElementById('purpose').value = decomposition.purpose || '';
            document.getElementById('tone').value = decomposition.tone || '';
            document.getElementById('length').value = decomposition.length || '';
            document.getElementById('facts').value = decomposition.facts_or_constraints?.join(', ') || '';
            document.getElementById('callToAction').value = decomposition.call_to_action || '';
            
            // å¡«å……é—œéµè¦é»
            const container = document.getElementById('keyPointsContainer');
            container.innerHTML = '';
            
            if (decomposition.key_points && decomposition.key_points.length > 0) {
                decomposition.key_points.forEach(point => {
                    addKeyPointInput(point);
                });
            } else {
                addKeyPointInput();
            }
        }

        function addKeyPoint() {
            addKeyPointInput();
        }

        function addKeyPointInput(value = '') {
            const container = document.getElementById('keyPointsContainer');
            const div = document.createElement('div');
            div.className = 'key-point-item';
            div.innerHTML = `
                <input type="text" class="key-point-input" value="${value}" placeholder="è¼¸å…¥é—œéµè¦é»">
                <button type="button" class="btn-remove" onclick="removeKeyPoint(this)">Ã—</button>
            `;
            container.appendChild(div);
        }

        function removeKeyPoint(button) {
            button.parentElement.remove();
        }

        // Step 2: ç¢ºèªæ‹†è§£å…§å®¹
        async function confirmDecomposition() {
            const decomposition = {
                title_suggestion: document.getElementById('title').value,
                audience: document.getElementById('audience').value,
                purpose: document.getElementById('purpose').value,
                tone: document.getElementById('tone').value,
                length: document.getElementById('length').value,
                key_points: Array.from(document.querySelectorAll('.key-point-input')).map(input => input.value).filter(v => v.trim()),
                facts_or_constraints: document.getElementById('facts').value.split(',').map(s => s.trim()).filter(s => s),
                call_to_action: document.getElementById('callToAction').value
            };
            
            try {
                const response = await fetch('/confirm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ decomposition })
                });
                
                const data = await response.json();
                currentConfirmedId = data.confirmed_id;
                
                // é¡¯ç¤ºStep 3
                showStep(3);
                updateProgress(3);
                
            } catch (error) {
                console.error('ç¢ºèªå¤±æ•—:', error);
                alert('ç¢ºèªå¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        // Step 3: ç”Ÿæˆæ–‡æ¡ˆ
        async function generateContent() {
            const style = document.querySelector('input[name="style"]:checked').value;
            const form = document.querySelector('input[name="form"]:checked').value;
            const length = document.querySelector('input[name="length"]:checked').value;
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        confirmed_id: currentConfirmedId,
                        style,
                        form,
                        length
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                currentVersionId = data.version_id;
                
                // é¡¯ç¤ºç”Ÿæˆçµæœ
                document.getElementById('generatedText').textContent = data.generated_text;
                document.getElementById('resultMeta').innerHTML = `
                    <span>é¢¨æ ¼ï¼š${data.metadata.style}</span>
                    <span>å½¢å¼ï¼š${data.metadata.form}</span>
                    <span>é•·åº¦ï¼š${data.metadata.length}</span>
                    <span>æ™‚é–“ï¼š${new Date(data.metadata.timestamp).toLocaleString()}</span>
                `;
                
                // é¡¯ç¤ºStep 4
                showStep(4);
                updateProgress(4);
                
                // è¼‰å…¥ç‰ˆæœ¬ç´€éŒ„
                loadVersions();
                
            } catch (error) {
                console.error('ç”Ÿæˆå¤±æ•—:', error);
                alert('ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        // Step 4: ä¸‹è¼‰æ–‡æ¡ˆ
        async function downloadContent() {
            if (!currentVersionId) {
                alert('æ²’æœ‰å¯ä¸‹è¼‰çš„æ–‡æ¡ˆ');
                return;
            }
            
            window.open(`/download/${currentVersionId}`, '_blank');
        }

        // é‡æ–°ç”Ÿæˆæ–‡æ¡ˆ
        async function regenerateContent() {
            const style = document.querySelector('input[name="style"]:checked').value;
            const form = document.querySelector('input[name="form"]:checked').value;
            const length = document.querySelector('input[name="length"]:checked').value;
            
            try {
                const response = await fetch('/regenerate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        confirmed_id: currentConfirmedId,
                        style,
                        form,
                        length
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                currentVersionId = data.version_id;
                
                // æ›´æ–°é¡¯ç¤ºçµæœ
                document.getElementById('generatedText').textContent = data.generated_text;
                document.getElementById('resultMeta').innerHTML = `
                    <span>é¢¨æ ¼ï¼š${data.metadata.style}</span>
                    <span>å½¢å¼ï¼š${data.metadata.form}</span>
                    <span>é•·åº¦ï¼š${data.metadata.length}</span>
                    <span>æ™‚é–“ï¼š${new Date(data.metadata.timestamp).toLocaleString()}</span>
                `;
                
                // é‡æ–°è¼‰å…¥ç‰ˆæœ¬ç´€éŒ„
                loadVersions();
                
            } catch (error) {
                console.error('é‡æ–°ç”Ÿæˆå¤±æ•—:', error);
                alert('é‡æ–°ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        // ä¿®æ”¹æ‹†è§£å…§å®¹
        function modifyDecomposition() {
            showStep(2);
            updateProgress(2);
        }

        // è¼‰å…¥ç‰ˆæœ¬ç´€éŒ„
        async function loadVersions() {
            if (!currentConfirmedId) return;
            
            try {
                const response = await fetch(`/versions/${currentConfirmedId}`);
                const versions = await response.json();
                
                if (versions.length > 0) {
                    const container = document.getElementById('versionsContainer');
                    const list = document.getElementById('versionsList');
                    
                    list.innerHTML = versions.map(version => `
                        <div class="version-item">
                            <div class="version-info">
                                <span class="version-style">${version.style}</span>
                                <span class="version-form">${version.form}</span>
                                <span class="version-length">${version.length}</span>
                                <span class="version-time">${new Date(version.timestamp).toLocaleString()}</span>
                            </div>
                            <div class="version-actions">
                                <button class="btn btn-small" onclick="downloadVersion('${version.id}')">ä¸‹è¼‰</button>
                            </div>
                        </div>
                    `).join('');
                    
                    container.style.display = 'block';
                }
            } catch (error) {
                console.error('è¼‰å…¥ç‰ˆæœ¬ç´€éŒ„å¤±æ•—:', error);
            }
        }

        // ä¸‹è¼‰ç‰¹å®šç‰ˆæœ¬
        async function downloadVersion(versionId) {
            window.open(`/download/${versionId}`, '_blank');
        }

        // é¡¯ç¤ºæŒ‡å®šæ­¥é©Ÿ
        function showStep(stepNumber) {
            // éš±è—æ‰€æœ‰æ­¥é©Ÿ
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).style.display = 'none';
            }
            
            // é¡¯ç¤ºæŒ‡å®šæ­¥é©Ÿ
            document.getElementById(`step${stepNumber}`).style.display = 'block';
        }

        // æ›´æ–°é€²åº¦æ¢
        function updateProgress(activeStep) {
            const steps = document.querySelectorAll('.progress-step');
            steps.forEach((step, index) => {
                if (index + 1 <= activeStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateProgress(1);
        });
    </script>
</body>
</html>
