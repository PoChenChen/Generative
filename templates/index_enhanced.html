<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 文案生成工具 - 增強版本</title>
    <link rel="stylesheet" href="/static/style_enhanced.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>🚀 AI 文案生成工具 - 增強版本</h1>
            <p class="subtitle">實現未來規劃：多語言支援、擴展風格、批量處理</p>
            <div class="version-badge">v2.0</div>
        </header>

        <!-- 功能選擇器 -->
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="single">單一文案</button>
            <button class="mode-btn" data-mode="batch">批量處理</button>
        </div>

        <!-- 單一文案模式 -->
        <div id="single-mode" class="mode-content active">
            <!-- Step 1: 輸入原始文字 -->
            <section class="step-section" id="step1">
                <div class="step-header">
                    <span class="step-number">1</span>
                    <h2>輸入原始文字</h2>
                </div>
                
                <div class="input-group">
                    <label for="language">選擇語言：</label>
                    <select id="language">
                        <option value="自動檢測">自動檢測</option>
                        <option value="中文">中文</option>
                        <option value="英文">英文</option>
                        <option value="日文">日文</option>
                        <option value="韓文">韓文</option>
                        <option value="法文">法文</option>
                        <option value="德文">德文</option>
                        <option value="西班牙文">西班牙文</option>
                        <option value="葡萄牙文">葡萄牙文</option>
                        <option value="義大利文">義大利文</option>
                        <option value="俄文">俄文</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="inputText">貼上您的原始文字：</label>
                    <textarea id="inputText" placeholder="請貼上文章、廣告文案、新聞稿等內容..."></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="decomposeText()">開始解析</button>
            </section>

            <!-- Step 2: 拆解內容確認 -->
            <section class="step-section" id="step2" style="display: none;">
                <div class="step-header">
                    <span class="step-number">2</span>
                    <h2>確認拆解內容</h2>
                </div>
                
                <div class="decomposition-container">
                    <div class="decomposition-card">
                        <h3>標題建議</h3>
                        <input type="text" id="title" class="decomposition-input">
                    </div>
                    
                    <div class="decomposition-card">
                        <h3>目標受眾</h3>
                        <input type="text" id="audience" class="decomposition-input">
                    </div>
                    
                    <div class="decomposition-card">
                        <h3>文案目的</h3>
                        <input type="text" id="purpose" class="decomposition-input">
                    </div>
                    
                    <div class="decomposition-card">
                        <h3>語調風格</h3>
                        <input type="text" id="tone" class="decomposition-input">
                    </div>
                    
                    <div class="decomposition-card">
                        <h3>建議長度</h3>
                        <input type="text" id="length" class="decomposition-input">
                    </div>
                    
                    <div class="decomposition-card full-width">
                        <h3>關鍵要點</h3>
                        <div id="keyPointsContainer" class="key-points-container">
                            <!-- 動態生成要點輸入框 -->
                        </div>
                        <button class="btn btn-secondary" onclick="addKeyPoint()">新增要點</button>
                    </div>
                    
                    <div class="decomposition-card">
                        <h3>事實或限制</h3>
                        <input type="text" id="facts" class="decomposition-input">
                    </div>
                    
                    <div class="decomposition-card">
                        <h3>行動呼籲</h3>
                        <input type="text" id="callToAction" class="decomposition-input">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="confirmDecomposition()">確認拆解內容</button>
            </section>

            <!-- Step 3: 生成新文案 -->
            <section class="step-section" id="step3" style="display: none;">
                <div class="step-header">
                    <span class="step-number">3</span>
                    <h2>生成新文案</h2>
                </div>
                
                <div class="generation-options">
                    <div class="option-group">
                        <label>文案風格：</label>
                        <div class="radio-group" id="styleOptions">
                            <!-- 動態生成風格選項 -->
                        </div>
                    </div>
                    
                    <div class="option-group">
                        <label>文案形式：</label>
                        <div class="radio-group" id="formOptions">
                            <!-- 動態生成形式選項 -->
                        </div>
                    </div>
                    
                    <div class="option-group">
                        <label>字數長度：</label>
                        <div class="radio-group">
                            <label><input type="radio" name="length" value="短"> 短</label>
                            <label><input type="radio" name="length" value="中" checked> 中</label>
                            <label><input type="radio" name="length" value="長"> 長</label>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="generateContent()">生成文案</button>
            </section>

            <!-- Step 4: 顯示與迭代 -->
            <section class="step-section" id="step4" style="display: none;">
                <div class="step-header">
                    <span class="step-number">4</span>
                    <h2>生成結果與迭代</h2>
                </div>
                
                <div class="result-container">
                    <div class="result-header">
                        <h3>生成的文案</h3>
                        <div class="result-meta" id="resultMeta"></div>
                    </div>
                    
                    <div class="generated-text" id="generatedText"></div>
                    
                    <div class="result-actions">
                        <button class="btn btn-success" onclick="downloadContent()">下載文案</button>
                        <button class="btn btn-secondary" onclick="regenerateContent()">重新生成</button>
                        <button class="btn btn-outline" onclick="modifyDecomposition()">修改拆解內容</button>
                    </div>
                </div>
                
                <div class="versions-container" id="versionsContainer" style="display: none;">
                    <h3>版本紀錄</h3>
                    <div id="versionsList"></div>
                </div>
            </section>
        </div>

        <!-- 批量處理模式 -->
        <div id="batch-mode" class="mode-content">
            <section class="step-section">
                <div class="step-header">
                    <span class="step-number">📦</span>
                    <h2>批量文案生成</h2>
                </div>
                
                <div class="batch-input-container">
                    <div class="batch-textarea-group">
                        <label>輸入多個文字（每行一個）：</label>
                        <textarea id="batchTexts" placeholder="第一段文字&#10;第二段文字&#10;第三段文字..."></textarea>
                    </div>
                    
                    <div class="batch-options">
                        <div class="batch-option">
                            <label>預設風格：</label>
                            <select id="batchStyle">
                                <option value="專業">專業</option>
                                <option value="活潑">活潑</option>
                                <option value="學術">學術</option>
                                <option value="幽默">幽默</option>
                                <option value="溫馨">溫馨</option>
                                <option value="激勵">激勵</option>
                                <option value="神秘">神秘</option>
                                <option value="優雅">優雅</option>
                            </select>
                        </div>
                        
                        <div class="batch-option">
                            <label>預設形式：</label>
                            <select id="batchForm">
                                <option value="社群貼文">社群貼文</option>
                                <option value="Email標題">Email標題</option>
                                <option value="完整文章">完整文章</option>
                                <option value="廣告文案">廣告文案</option>
                                <option value="新聞稿">新聞稿</option>
                                <option value="產品描述">產品描述</option>
                                <option value="活動宣傳">活動宣傳</option>
                                <option value="品牌故事">品牌故事</option>
                            </select>
                        </div>
                        
                        <div class="batch-option">
                            <label>預設長度：</label>
                            <select id="batchLength">
                                <option value="短">短</option>
                                <option value="中">中</option>
                                <option value="長">長</option>
                            </select>
                        </div>
                        
                        <div class="batch-option">
                            <label>預設語言：</label>
                            <select id="batchLanguage">
                                <option value="中文">中文</option>
                                <option value="英文">英文</option>
                                <option value="日文">日文</option>
                                <option value="韓文">韓文</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="startBatchProcess()">開始批量處理</button>
                </div>
                
                <div class="batch-progress" id="batchProgress" style="display: none;">
                    <h3>處理進度</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">準備中...</div>
                </div>
                
                <div class="batch-results" id="batchResults" style="display: none;">
                    <h3>處理結果</h3>
                    <div class="batch-summary" id="batchSummary"></div>
                    <button class="btn btn-success" onclick="downloadBatchResults()">下載所有結果</button>
                </div>
            </section>
        </div>

        <!-- 進度指示器 -->
        <div class="progress-bar">
            <div class="progress-step active" data-step="1">輸入</div>
            <div class="progress-step" data-step="2">拆解</div>
            <div class="progress-step" data-step="3">生成</div>
            <div class="progress-step" data-step="4">完成</div>
        </div>
    </div>

    <script>
        let currentConfirmedId = null;
        let currentVersionId = null;
        let currentBatchJobId = null;
        let supportedLanguages = {};
        let enhancedStyles = {};
        let enhancedForms = {};

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateProgress(1);
            loadAPIResources();
            setupModeSelector();
        });

        // 載入API資源
        async function loadAPIResources() {
            try {
                // 載入支援的語言
                const langResponse = await fetch('/api/languages');
                supportedLanguages = await langResponse.json();
                
                // 載入支援的風格
                const styleResponse = await fetch('/api/styles');
                enhancedStyles = await styleResponse.json();
                
                // 載入支援的形式
                const formResponse = await fetch('/api/forms');
                enhancedForms = await formResponse.json();
                
                // 更新風格選項
                updateStyleOptions();
                updateFormOptions();
                
            } catch (error) {
                console.error('載入API資源失敗:', error);
            }
        }

        // 更新風格選項
        function updateStyleOptions() {
            const container = document.getElementById('styleOptions');
            container.innerHTML = '';
            
            Object.entries(enhancedStyles).forEach(([style, info]) => {
                const label = document.createElement('label');
                label.innerHTML = `
                    <input type="radio" name="style" value="${style}" ${style === '專業' ? 'checked' : ''}>
                    ${info.emoji} ${style}
                    <span class="style-description">${info.description}</span>
                `;
                container.appendChild(label);
            });
        }

        // 更新形式選項
        function updateFormOptions() {
            const container = document.getElementById('formOptions');
            container.innerHTML = '';
            
            Object.entries(enhancedForms).forEach(([form, info]) => {
                const label = document.createElement('label');
                label.innerHTML = `
                    <input type="radio" name="form" value="${form}" ${form === '完整文章' ? 'checked' : ''}>
                    ${form}
                    <span class="form-description">${info.description}</span>
                `;
                container.appendChild(label);
            });
        }

        // 設置模式選擇器
        function setupModeSelector() {
            const modeBtns = document.querySelectorAll('.mode-btn');
            const modeContents = document.querySelectorAll('.mode-content');
            
            modeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.dataset.mode;
                    
                    // 更新按鈕狀態
                    modeBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // 更新內容顯示
                    modeContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${mode}-mode`) {
                            content.classList.add('active');
                        }
                    });
                });
            });
        }

        // Step 1: 拆解文字
        async function decomposeText() {
            const text = document.getElementById('inputText').value.trim();
            const language = document.getElementById('language').value;
            
            if (!text) {
                alert('請輸入文字內容');
                return;
            }
            
            try {
                const response = await fetch('/decompose', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({ text, language })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // 填充拆解內容
                fillDecomposition(data.decomposition);
                
                // 顯示Step 2
                showStep(2);
                updateProgress(2);
                
            } catch (error) {
                console.error('拆解失敗:', error);
                alert('拆解失敗，請重試');
            }
        }

        function fillDecomposition(decomposition) {
            document.getElementById('title').value = decomposition.title_suggestion || '';
            document.getElementById('audience').value = decomposition.audience || '';
            document.getElementById('purpose').value = decomposition.purpose || '';
            document.getElementById('tone').value = decomposition.tone || '';
            document.getElementById('length').value = decomposition.length || '';
            document.getElementById('facts').value = decomposition.facts_or_constraints?.join(', ') || '';
            document.getElementById('callToAction').value = decomposition.call_to_action || '';
            
            // 填充關鍵要點
            const container = document.getElementById('keyPointsContainer');
            container.innerHTML = '';
            
            if (decomposition.key_points && decomposition.key_points.length > 0) {
                decomposition.key_points.forEach(point => {
                    addKeyPointInput(point);
                });
            } else {
                addKeyPointInput();
            }
        }

        function addKeyPoint() {
            addKeyPointInput();
        }

        function addKeyPointInput(value = '') {
            const container = document.getElementById('keyPointsContainer');
            const div = document.createElement('div');
            div.className = 'key-point-item';
            div.innerHTML = `
                <input type="text" class="key-point-input" value="${value}" placeholder="輸入關鍵要點">
                <button type="button" class="btn-remove" onclick="removeKeyPoint(this)">×</button>
            `;
            container.appendChild(div);
        }

        function removeKeyPoint(button) {
            button.parentElement.remove();
        }

        // Step 2: 確認拆解內容
        async function confirmDecomposition() {
            const decomposition = {
                title_suggestion: document.getElementById('title').value,
                audience: document.getElementById('audience').value,
                purpose: document.getElementById('purpose').value,
                tone: document.getElementById('tone').value,
                length: document.getElementById('length').value,
                key_points: Array.from(document.querySelectorAll('.key-point-input')).map(input => input.value).filter(v => v.trim()),
                facts_or_constraints: document.getElementById('facts').value.split(',').map(s => s.trim()).filter(s => s),
                call_to_action: document.getElementById('callToAction').value
            };
            
            try {
                const response = await fetch('/confirm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ decomposition })
                });
                
                const data = await response.json();
                currentConfirmedId = data.confirmed_id;
                
                // 顯示Step 3
                showStep(3);
                updateProgress(3);
                
            } catch (error) {
                console.error('確認失敗:', error);
                alert('確認失敗，請重試');
            }
        }

        // Step 3: 生成文案
        async function generateContent() {
            const style = document.querySelector('input[name="style"]:checked').value;
            const form = document.querySelector('input[name="form"]:checked').value;
            const length = document.querySelector('input[name="length"]:checked').value;
            const language = document.getElementById('language').value;
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        confirmed_id: currentConfirmedId,
                        style,
                        form,
                        length,
                        language
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                currentVersionId = data.version_id;
                
                // 顯示生成結果
                document.getElementById('generatedText').textContent = data.generated_text;
                document.getElementById('resultMeta').innerHTML = `
                    <span>風格：${data.metadata.style}</span>
                    <span>形式：${data.metadata.form}</span>
                    <span>長度：${data.metadata.length}</span>
                    <span>語言：${data.metadata.language}</span>
                    <span>時間：${new Date(data.metadata.timestamp).toLocaleString()}</span>
                `;
                
                // 顯示Step 4
                showStep(4);
                updateProgress(4);
                
                // 載入版本紀錄
                loadVersions();
                
            } catch (error) {
                console.error('生成失敗:', error);
                alert('生成失敗，請重試');
            }
        }

        // 批量處理功能
        async function startBatchProcess() {
            const texts = document.getElementById('batchTexts').value.split('\n').filter(t => t.trim());
            const style = document.getElementById('batchStyle').value;
            const form = document.getElementById('batchForm').value;
            const length = document.getElementById('batchLength').value;
            const language = document.getElementById('batchLanguage').value;
            
            if (texts.length === 0) {
                alert('請輸入要處理的文字');
                return;
            }
            
            try {
                const response = await fetch('/batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        texts,
                        styles: [style] * texts.length,
                        forms: [form] * texts.length,
                        lengths: [length] * texts.length,
                        languages: [language] * texts.length
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                currentBatchJobId = data.job_id;
                
                // 顯示進度
                document.getElementById('batchProgress').style.display = 'block';
                document.getElementById('batchResults').style.display = 'none';
                
                // 開始監控進度
                monitorBatchProgress();
                
            } catch (error) {
                console.error('批量處理失敗:', error);
                alert('批量處理失敗，請重試');
            }
        }

        // 監控批量處理進度
        async function monitorBatchProgress() {
            if (!currentBatchJobId) return;
            
            try {
                const response = await fetch(`/batch/${currentBatchJobId}`);
                const job = await response.json();
                
                // 更新進度條
                const progress = (job.completed / job.total) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = `處理中... ${job.completed}/${job.total}`;
                
                if (job.status === 'completed') {
                    // 顯示結果
                    showBatchResults(job);
                } else {
                    // 繼續監控
                    setTimeout(monitorBatchProgress, 1000);
                }
                
            } catch (error) {
                console.error('監控進度失敗:', error);
            }
        }

        // 顯示批量處理結果
        function showBatchResults(job) {
            document.getElementById('batchProgress').style.display = 'none';
            document.getElementById('batchResults').style.display = 'block';
            
            const summary = document.getElementById('batchSummary');
            const successCount = job.results.filter(r => !r.error).length;
            const errorCount = job.results.filter(r => r.error).length;
            
            summary.innerHTML = `
                <div class="batch-stats">
                    <div class="stat-item">
                        <span class="stat-label">總數：</span>
                        <span class="stat-value">${job.total}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">成功：</span>
                        <span class="stat-value success">${successCount}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">失敗：</span>
                        <span class="stat-value error">${errorCount}</span>
                    </div>
                </div>
            `;
        }

        // 下載批量處理結果
        async function downloadBatchResults() {
            if (!currentBatchJobId) return;
            
            window.open(`/batch/${currentBatchJobId}/download`, '_blank');
        }

        // 其他功能函數
        async function downloadContent() {
            if (!currentVersionId) {
                alert('沒有可下載的文案');
                return;
            }
            
            window.open(`/download/${currentVersionId}`, '_blank');
        }

        async function regenerateContent() {
            const style = document.querySelector('input[name="style"]:checked').value;
            const form = document.querySelector('input[name="form"]:checked').value;
            const length = document.querySelector('input[name="length"]:checked').value;
            const language = document.getElementById('language').value;
            
            try {
                const response = await fetch('/regenerate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        confirmed_id: currentConfirmedId,
                        style,
                        form,
                        length,
                        language
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                currentVersionId = data.version_id;
                
                // 更新顯示結果
                document.getElementById('generatedText').textContent = data.generated_text;
                document.getElementById('resultMeta').innerHTML = `
                    <span>風格：${data.metadata.style}</span>
                    <span>形式：${data.metadata.form}</span>
                    <span>長度：${data.metadata.length}</span>
                    <span>語言：${data.metadata.language}</span>
                    <span>時間：${new Date(data.metadata.timestamp).toLocaleString()}</span>
                `;
                
                // 重新載入版本紀錄
                loadVersions();
                
            } catch (error) {
                console.error('重新生成失敗:', error);
                alert('重新生成失敗，請重試');
            }
        }

        function modifyDecomposition() {
            showStep(2);
            updateProgress(2);
        }

        async function loadVersions() {
            if (!currentConfirmedId) return;
            
            try {
                const response = await fetch(`/versions/${currentConfirmedId}`);
                const versions = await response.json();
                
                if (versions.length > 0) {
                    const container = document.getElementById('versionsContainer');
                    const list = document.getElementById('versionsList');
                    
                    list.innerHTML = versions.map(version => `
                        <div class="version-item">
                            <div class="version-info">
                                <span class="version-style">${version.style}</span>
                                <span class="version-form">${version.form}</span>
                                <span class="version-length">${version.length}</span>
                                <span class="version-language">${version.language || '中文'}</span>
                                <span class="version-time">${new Date(version.timestamp).toLocaleString()}</span>
                            </div>
                            <div class="version-actions">
                                <button class="btn btn-small" onclick="downloadVersion('${version.id}')">下載</button>
                            </div>
                        </div>
                    `).join('');
                    
                    container.style.display = 'block';
                }
            } catch (error) {
                console.error('載入版本紀錄失敗:', error);
            }
        }

        async function downloadVersion(versionId) {
            window.open(`/download/${versionId}`, '_blank');
        }

        function showStep(stepNumber) {
            // 隱藏所有步驟
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).style.display = 'none';
            }
            
            // 顯示指定步驟
            document.getElementById(`step${stepNumber}`).style.display = 'block';
        }

        function updateProgress(activeStep) {
            const steps = document.querySelectorAll('.progress-step');
            steps.forEach((step, index) => {
                if (index + 1 <= activeStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
        }
    </script>
</body>
</html>
